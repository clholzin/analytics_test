<!DOCTYPE html>
<html>
<head>
    <title>Dassian App</title>
    <meta charset="UTF-8">
    <!--link href="./assets/css/kendo.dataviz.default.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common-bootstrap.core.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common-bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.bootstrap.min.css" rel="stylesheet">-->
    <link href="./assets/css/kendo.dataviz.bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common-fiori.core.min.css" rel="stylesheet">

    <script src="./assets/js/jszip.min.js"></script>

    <link href="./assets/css/default.css" rel="stylesheet">
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/kendo.common-fiori.min.css"/>
    <link rel="stylesheet" href="./assets/css/kendo.fiori.min.css"/>
    <link rel="stylesheet" href="./assets/css/kendo.dataviz.min.css"/>
    <link rel="stylesheet" href="./assets/css/kendo.dataviz.fiori.min.css"/>

    <script src="./assets/js/jquery.min.js"></script>
    <script src="./assets/js/underscore.js"></script>
    <script src="./assets/js/kendo.culture.en-GB.min.js"></script>
    <script src="./assets/js/kendo.all.js"></script>
    <!-- <script src="./assets/js/moment.js"></script>-->
</head>

<body>

<!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container">
        <div class="navbar-header">
            <a class="navbar-brand" target="_blank" href="http://www.dassian.com">
                <img alt="Dassian UK" src="assets/img/dassian.png" width="100px"></a>
        </div>
        <p style="margin-right: 5px" class="navbar-text navbar-right">Signed in as
            <a href="#" class="navbar-link">Tom Lau</a></p>

    </div>
</nav>

<div class="container dashboard">
    <div class="panel panel-default ">
        <div class="panel-heading">
            <h3 class="panel-title">Project Analytics
                <span class="pull-right dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><span
                        class="k-icon k-i-hbars"></span></a>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="#">Action</a></li>
                    <li><a href="#">Another action</a></li>
                    <li><a href="#">Something else here</a></li>
                    <li class="divider"></li>
                    <li><a href="#">Separated link</a></li>
                </ul>
                </span>
            </h3>
        </div>
        <div class="panel-body" style="padding: 0; margin: 0;">
            <!--   <div id="vertical" class="row" style="border: none">-->
            <div id="top-pane" class="row">
                <!--   <div id="horizontal" style="height: 100%; width: 100%;">-->
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="well" style="">
                        <div class="treelist-loading"></div>
                        <div id="treelist"></div>
                    </div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="well">
                        <div id="gauge-container">
                            <div class="gauge-loading"></div>
                            <div style="border: solid thin #3d3d3d;">
                                <div id="topgauge"></div>
                            </div>
                            <input id="gauge-value" class="form-control" value="1.5">

                            <div style="border: solid thin #3d3d3d;">
                                <div id="bottomgauge"></div>
                            </div>
                            <input id="gauge-value-bottom" class="form-control" value=".5">
                        </div>
                    </div>
                </div>
                <!-- </div>-->
            </div>
            <div class="row">
                <div class="dropdown">
                    <button class="btn btn-default"><span class="export-pdf k-icon k-i-pdf"></span></button>
                    <button class="btn btn-default dropdown-toggle" type="button" id="dropdownMenu1"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                        Charts
                        <span class="caret"></span>
                    </button>
                    <button class="btn btn-primary btn-sm total-bcws"></button>
                    <button class="btn btn-info btn-sm total-bdwp"></button>
                    <button class="btn btn-success btn-sm total-eac"></button>
                    <button class="btn btn-warning btn-sm total-acwp"></button>

                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                        <li class="options">
                            <label for="typeArea">Area</label>
                            <input id="typeArea" name="seriesType" type="radio" value="area" autocomplete="off"/>
                        </li>
                        <li class="options">
                            <label for="typeColumn">Columns</label>
                            <input id="typeColumn" name="seriesType" type="radio" value="column" autocomplete="off"/>
                        </li>
                        <!-- <li class="options">
                             <label for="typeBar">Bars</label>
                             <input id="typeBar" name="seriesType" type="radio" value="bar" autocomplete="off"/>
                         </li>
                        <li class="options">
                            <label for="typeBubble">Bubble</label>
                            <input id="typeBubble" name="seriesType" type="radio" value="bubble" autocomplete="off"/>
                        </li>-->
                        <li class="options">
                            <label for="typeLine">Lines</label>
                            <input id="typeLine" name="seriesType" type="radio" value="line" autocomplete="off"
                                   checked="checked"/>
                        </li>
                        <li class="options">
                            <label for="stack">Stacked</label>
                            <input id="stack" type="checkbox" autocomplete="off"/>
                        </li>
                    </ul>
                </div>
                <div class="well well-lg">

                    <div  id="chart">
                        <div class="chart-loading"></div>
                    </div>

                </div>
            </div>
            <!--  </div>-->
        </div>
    </div>
</div>
<div class="navbar navbar-default navbar-fixed-bottom">
    <div class="navbar-header">
        <p class="navbar-text navbar-left"><span class="k-icon k-i-custom"></span></p>
    </div>
    <p style="margin-right: 10px" class="navbar-text navbar-right"><span class="export-pdf k-icon k-i-pdf"></span>
    </p>
</div>

</body>
<!-- Placed at the end of the document so the pages load faster -->
<script src="./assets/js/bootstrap.min.js"></script>
<script>

    $(document).ready(function () {
        // var culture = kendo.culture();
        //  console.log(culture.name);
        var body = $("body");
        kendo.culture('en-GB');
        /** console currency check**/
        console.log(kendo.toString(1234.567, "c0"));//$1,235

        /** CH
         * Add Loading-Wheel to chart hierarchy and gauges
         * */
        AddClearProgress(true);
      /**  _.debounce(
                kendo.ui.progress($(".treelist-loading"),false)
                ,500);
        _.debounce(kendo.ui.progress($(".gauge-loading"), false),750);
        _.debounce(kendo.ui.progress($(".chart-loading"), false),1000);**/



        createGauge();

        if (kendo.ui.Slider) {
            $("#gauge-value").kendoSlider({
                min: 0,
                max: 2,
                showButtons: true,
                change: updateValueTop
            });
            $("#gauge-value-bottom").kendoSlider({
                min: 0,
                max: 2,
                showButtons: true,
                change: updateValueBottom
            });
        } else {
            $("#gauge-value").change(updateValueTop);
            $("#gauge-value-bottom").change(updateValueBottom);
        }
        function updateValueTop() {
            $("#topgauge").data("kendoRadialGauge").value($("#gauge-value").val());
        }

        function updateValueBottom() {
            $("#bottomgauge").data("kendoRadialGauge").value($("#gauge-value-bottom").val());
        }

        /** $(document).bind("kendo:skinChange", function (e) {
            createGauge();
        });**/


        /** Begin Hierarchy Panel **/
        hierListData();
        // $('#treelist').find('tr.k-treelist-group').attr("aria-expanded",'true');
        //  var data = hierData();
        //  console.log(data);

        var chartData = ChartData();
        var chartDataSource =  FilterChartData(chartData);
        var chartTotals = chartDataSource.totals;
        var chart = chartDataSource.graph;
        console.log(bcwsTotalCost);
        displayTotals(chartTotals);



        console.log(JSON.stringify(chartTotals));
       // console.log(JSON.stringify(chart));
        var dataSourceMixed = new kendo.data.DataSource({
            data: _.flatten(chart),
            sort: {
                field: "Date",
                dir: "asc"
            },
            schema: {
                model: {
                    fields: {
                        // IntValProjCurr: {type: "number"},
                        Date: {type: "date"}
                    }
                }
            }

        });

        var series = [
            {
                name: "BCWS",
                type: "line",
                field: "BCWS",
                categoryField: "Date",
                //data:BCWSdata,//_.pluck(BCWS, 'IntValProjCurr')
                // Line chart marker type
                color: "#428bca",
                markers: {type: "circle"}
            },
            {
                name: "BCWP",
                type: "line",
                field: "BCWP",
                categoryField: "Date",
                //data:BCWPdata,
                color: "#5bc0de",
                markers: {type: "circle"}
            },
            {
                name: "EAC",
                type: "line",
                field: "EAC",
                categoryField: "Date",
                //data:EACdata,
                color: "#5cb85c",
                markers: {type: "circle"}
            },
            {
                name: "ACWP",
                type: "line",
                field: "ACWP",
                categoryField: "Date",
                //data:ACWPdata,
                color: "#f0ad4e",
                markers: {type: "circle"}
            }
        ];

        createChart(dataSourceMixed, series);

        $(document).bind("kendo:skinChange", createChart);
        $("li.options").bind("change", refreshChart);
        var hierarchyList = $("div#treelist");
        //var dataTreeListSelected = treeList.dataItem(row);
      //  console.log(dataTreeListSelected);

        hierarchyList.on('click','tr',function(e){
            e.preventDefault();
            console.log('hit selected row');
            var treeList = hierarchyList.data("kendoTreeList");
            var rowIndex = $(e.currentTarget).index();
            console.log(rowIndex);
            var data = treeList.dataSource.options.data[rowIndex];
            console.log(data.ParentObjNum);
            var id = data.ParentObjNum;
            var chartData = ChartData();
            var filteredSnapByParentId = FilterByHierList(id,chartData);
            var chartDataSource =  FilterChartData(filteredSnapByParentId);

            var chartTotalsFilteredBy = chartDataSource.totals;
            displayTotals(chartTotalsFilteredBy);

            var chartFilteredByParentId = chartDataSource.graph;
            var dataSourceFilteredParentId = new kendo.data.DataSource({
                data: _.flatten(chartFilteredByParentId),
                sort: {
                    field: "Date",
                    dir: "asc"
                },
                schema: {
                    model: {
                        fields: {
                            // IntValProjCurr: {type: "number"},
                            Date: {type: "date"}
                        }
                    }
                }

            });
            createChart(dataSourceFilteredParentId, series);
        });

        body.on('keypress',hierarchyList,function(e){
            console.log('hit selected row');
        });



        $(".export-pdf").click(function () {
            $("#chart").getKendoChart().saveAsPDF();
        });

        function refreshChart() {
            var chart = $("#chart").data("kendoChart"),
                    type = $("input[name=seriesType]:checked").val(),
                    stack = $("#stack").prop("checked");

            for (var i = 0, length = series.length; i < length; i++) {
                series[i].stack = stack;
                series[i].type = type;
            }

            chart.setOptions({
                series: series
            });
        }



        setTimeout(AddClearProgress(false), 3500);

    });//end of Doc Ready

    function displayTotals(data){
        var bcwsTotalCost = kendo.toString(data[0].bcwsTotal, "c");
        var bdwpTotalCost = kendo.toString(data[1].bdwpTotal, "c");
        var eacTotalCost = kendo.toString(data[2].eacTotal, "c");
        var acwpTotalCost = kendo.toString(data[3].acwpTotal, "c");
        $('button.total-bcws').text(bcwsTotalCost);//'&#163;'+
        $('button.total-bdwp').text(bdwpTotalCost);
        $('button.total-eac').text(eacTotalCost);
        $('button.total-acwp').text(acwpTotalCost);
    }


    function AddClearProgress(boolean){
        var loadingTree = $(document).find(".treelist-loading");
        var loadingGauges = $(document).find(".gauge-loading");
        var loadingChart = $(document).find(".chart-loading");
        kendo.ui.progress(loadingTree, boolean);
        kendo.ui.progress(loadingGauges, boolean);
        kendo.ui.progress(loadingChart, boolean);

    }


    function createGauge() {
      /**  var loadingGauges = $(document).find(".gauge-loading");
        _.debounce(kendo.ui.progress(loadingGauges, false),1000);**/
        $("#topgauge").kendoRadialGauge({
            pointer: {
                value: $("#gauge-value").val()
            },

            scale: {
                minorUnit: 5,
                startAngle: -30,
                endAngle: 210,
                max: 2
            }
        });
        $("#bottomgauge").kendoRadialGauge({
            pointer: {
                value: $("#gauge-value-bottom").val()
            },

            scale: {
                minorUnit: 5,
                startAngle: -30,
                endAngle: 210,
                max: 2
            }
        });
    }

    function hierListData() {
        var hierSource = '';
        $.ajax({
            url: "http://localhost/HierarchySet?$format=json",
            method: "GET",
            dataType: 'json',
            async: true
        }).success(function (response) {
            hierSource = response.d.results;
            hierListInitialize(hierSource)
        }).error(function (err) {
            alert('error ' + err);
        }).done(function () {
            console.log('HierarchySet complete ');

        });
    }

    function hierListInitialize(data) {
      /**  var loadingTree = $(document).find(".treelist-loading");
        _.debounce(kendo.ui.progress(loadingTree, false), 1000);**/

        $(document).find("#treelist").kendoTreeList({
            dataSource: {
                data: data,
                schema: {
                    parse: function (response) {
                        //  console.log(response);
                        var items = [];
                        $.each(response, function (index, value) {
                            var item = {
                                "parentId": String(value.ParentObjNum).substr(2),
                                "ParentObjNum": String(value.ParentObjNum).substr(2),
                                "id": String(value.ObjectNumber).substr(2),
                                "ObjectNumber": String(value.ObjectNumber).substr(2),
                                "Type": value.Type,
                                "ExtID": value.ExtID,
                                "Description": value.Description,
                                "Project": value.Project,
                                "SortOrder": value.SortOrder
                            };
                            items.push(item);
                        });
                        // console.log(JSON.stringify(items));

                        return items;
                    },
                    schema: {
                        model: {
                            //id: "id"
                            expanded: true
                        }
                    }
                },
                dataBound: function (e) {
                  /**  var tv = $("#treelist").data("kendoTreeView");
                    if (tv != null) {
                        tv.expand(".k-item");
                    }**/
                }
            },
            height: '450',
            selectable: true,
            //filterable: true,
            //sortable: true,
            resizable: true,
            columns: [
                {field: "ExtID", title: "ID", width: 160},
                //{ field: "ParentObjNum", title: "Parent", width: 120 },
                //  { field: "ObjectNumber", title: "Child", width: 120 },
                {field: "Project", width: 75, title: "Project"},
                {field: "Description", width: 160, title: "Description"}
                // { field: "ObjectNumber" }
            ]
        });
    }

    function ChartData() {
        var rawData ='';
        $.ajax({
            url: "http://localhost/SnapshotSet?$format=json",
            method: "GET",
            dataType: 'json',
            async: false
        }).success(function (response) {
            //dataChart = response.d.results;
            rawData = response.d.results;
        }).error(function (err) {
            alert('error ' + err);
        }).done(function () {
            console.log('request complete: SnapShotData');
        });

        return rawData;
    }
    function FilterByHierList(parentId,data){
        var findParentIds = [];
        if(parentId != undefined){
            var id = String(parentId).substr(2);
             findParentIds = $.grep(data,function(item){
                return String(item.ParentObjNum).substr(2) === id
            });
        }else{
            alert('Try clicking on the list row again!');
        }
        return _.flatten(findParentIds);
    }

    function FilterChartData(results){
        var master = {};
        master.graph = [];
        master.totals = [];
        if(results.length === 0){
            return alert('No Data');
        }
        var data = results;
        var BCWS = $.grep(data, function (item) {
            if (item.Version === 'D02') {
                return item.ValueType === '01';
            }
        });//filter data
        var BCWP = $.grep(data, function (item) {
            if (item.Version === 'D02') {
                return item.ValueType === 'P2';
            }
        });//filter data
        var EAC = $.grep(data, function (item) {
            if (item.Version === 'EA1') {
                return item;
            }
        });//filter data
        var ACWP = $.grep(data, function (item) {
            if (item.Version === '000') {
                return item;
            }
        });//filter data
        var BCWSdata = _.map(_.where(BCWS), function (value) {
            return {"BCWS": Number(value.IntValProjCurr), "Date": value.Date}
        });//convert IntValProjCurr key for Chart Series
        var bcwsTotal = 0;
        $.each(BCWSdata,function(key,value){
            bcwsTotal += parseFloat(value.BCWS);
        });
        master.totals.push({"bcwsTotal" : bcwsTotal});//.toFixed(2)
        master.graph.push(BCWSdata);//add array to master array

        var BCWPdata = _.map(_.where(BCWP), function (value) {
            return {"BCWP": Number(value.IntValProjCurr), "Date": value.Date}
        });//convert IntValProjCurr key for Chart Series
        var bdwpTotal = 0;
        $.each(BCWPdata,function(key,value){
            bdwpTotal += parseFloat(value.BCWP);
        });
        master.totals.push({"bdwpTotal" : bdwpTotal});//.toFixed(2)
        master.graph.push(BCWPdata);//add array to master array

        var EACdata = _.map(_.where(EAC), function (value) {
            return {"EAC": Number(value.IntValProjCurr), "Date": value.Date}
        });//convert IntValProjCurr key for Chart Series
        var eacTotal = 0;
        $.each(EACdata,function(key,value){
            eacTotal += parseFloat(value.EAC);
        });
        master.totals.push({"eacTotal" : eacTotal});//.toFixed(2)
        master.graph.push(EACdata);//add array to master array

        var ACWPdata = _.map(_.where(ACWP), function (value) {
            return {"ACWP": Number(value.IntValProjCurr), "Date": value.Date}
        });//convert IntValProjCurr key for Chart Series
        var acwpTotal = 0;
        $.each(ACWPdata,function(key,value){
            acwpTotal += parseFloat(value.ACWP);
        });
        master.totals.push({"acwpTotal" : acwpTotal});//.toFixed(2)
        master.graph.push(ACWPdata);//add array to master array

        _.flatten(master.graph);
        _.flatten(master.totals);
        return master;
    }

    function createChart(dataSource, series) {
       /** var loadingChart = $(document).find(".chart-loading");
        _.debounce(kendo.ui.progress(loadingChart, false),1000);**/
        $("#chart").kendoChart({
            pdf: {
                fileName: "SnapShot Costs Export.pdf",
                proxyURL: "http://localhost/kendo-ui/service/export"
            },
            dataSource: dataSource,
            chartArea: {
                //width: 500,
                height: 550
            },
            title: {
                text: "SnapshotSet"
            },
            legend: {
                position: "top"
            },
            seriesDefaults: {
                type: "line",
                markers: {
                    size: 5
                }
            },
            series: series,
            render: function (e) {
                // Clear up the loading indicator for this chart
               // var loading = $(".chart-loading");//, e.sender.element.parent()
              //  kendo.ui.progress($(".chart-loading"), false);
              //  kendo.ui.progress(loading, false);
            },
            categoryAxis: {
                baseUnit: "fit",
                title: {
                    text: "Date"
                },
                field: "Date",
                labels: {
                    rotation: -60,
                    dateFormats: {
                        days: "M/YYYY"
                    }
                },
                maxDateGroups: 65,
                crosshair: {
                    visible: false
                },
                line: {
                    visible: false
                },
                majorGridLines: {
                    visible: false
                }
            },
            valueAxis: {
                // name: "Currency",
                title: {text: ' Total'},//String('&#163;') +
                labels: {
                    format: "{0}"
                },//String('&#163;') +
                majorUnit: 750000,
                min: 0,
                max: 11000000
                /**, {
                name: "BCWP",
                title: { text: "BCWP" },
                min: 0,
                max: 161,
                majorUnit: 32
            }, {
                name: "EAC",
                title: { text: "EAC" },
                color: "#ec5e0a"
            }, {
                name: "ACWP",
                title: { text: "ACWP" },
                color: "#4e4141"
            }],**/
            },
            tooltip: {
                visible: true,
                shared: true,
                // format: "{0}",//&#163; {0}
                template: "#= kendo.format('{0:C}',value) #"
            }
        });
    }


    /**dataSource.fetch(function() {
        var data = dataSource.data();
        $.each(data,function(key,value){
            console.log(value.Date);
        });
    }); **/


    /**
     _.map(
     _.where(people, {city : "ny"}),
     function(person) {
               return { firstName: person.firstName, qty: person.qty };
            }
     );
     **/




    /**dataSource = new kendo.data.DataSource({
           // type: "odata",
            data:rawData,
            sort: {
                field: "Date",
                dir: "asc"
            },
            schema: {
                parse: function (response) {
                    //console.log(response.d.results);
                    var items = {};
                    items.d = {};
                    items.d.results = [];
                    $.each(response.d.results, function (index, value) {
                        var item = {
                         "ObjectNumber": value.ObjectNumber,
                            "Version": value.Version,
                            "ValueType": value.ValueType,
                            "TransactionType": value.TransactionType,
                            "ObjCurr": value.ObjCurr,
                            "Date": value.Date,
                           // "IntValProjCurr": value.IntValProjCurr
                            "ExtValProjCurr": value.ExtValProjCurr,
                            "IntValCOArCurr": value.IntValCOArCurr,
                            "ExtValCoArCurr": value.ExtValCoArCurr,
                            "Quantity": value.Quantity,
                            "Project": value.Project
                        };

                        items.d.results.push(item);
                    });
                    // console.log(JSON.stringify(items));
                    return items.d.results;
                },
                model: {
                    fields: {
                       // IntValProjCurr: {type: "number"},
                        Date: {type: "date"}
                    }
                }
            }

        });**/

</script>

</html>