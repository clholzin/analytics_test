<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="icon" href="./favicon.ico">

    <title>Dassian - Analytics Dashboard</title>

    <link rel="stylesheet" href="./assets/css/kendo.dataviz.bootstrap.min.css" />
    <link rel="stylesheet" href="./assets/css/kendo.common-fiori.core.min.css" />
    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="./assets/css/bootstrap.min.css">
    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="./assets/css/kendo.common-fiori.min.css" />
    <link rel="stylesheet" href="./assets/css/kendo.fiori.min.css" />
    <link rel="stylesheet" href="./assets/css/kendo.dataviz.min.css" />
    <link rel="stylesheet" href="./assets/css/kendo.dataviz.fiori.min.css" />
    <link rel="stylesheet" href="./assets/css/default.css">
    <link rel="stylesheet" href="./assets/css/animate.css">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body>
<!-- Fixed navbar -->
<div class="navbar navbar-default navbar-fixed-top">
    <div class="col-xs-6 navbar-header">
        <a class="navbar-brand" target="_blank" href="http://www.dassian.com"><img alt="Dassian UK" src="assets/img/dassian.png" width="100px"></a>
    </div>

    <div class="col-xs-6 text-right" style="padding-top: 15px">
        <p>Signed in as <a href="#" class="navbar-link">Tom Lau</a></p>
    </div>
</div>

<div class="panel panel-default" style="height:100%;">
    <div class="panel-heading">

        <h3 class="panel-title">Project Analytics

            <span class="pull-right dropdown">
            <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><span class="k-icon k-i-hbars"></span></a>
            <ul class="dropdown-menu" role="menu">
                <li><a href="#">Action</a></li>
                <li><a href="#">Another action</a></li>
                <li><a href="#">Something else here</a></li>
                <li class="divider"></li>
                <li><a href="#">Separated link</a></li>
            </ul>
            </span>
        </h3>
    </div>

    <div id="vertical">
        <div>
            <div id="horizontal">
                <div>
                    <div class="treelist-loading"></div>
                    <div id="treelist"></div>
                </div>
                <div>
                    <p class="js-hier-title">Hierarch ExtId will show here now.</p>
                    <div class="gauge-loading"></div>
                    <div class="gauge-container" style="display: inline-block">
                        <div id="lgauge" class="gauge"></div>
                        <div id="lgaugeTitle" class="gaugeTitle">SPI</div>
                    </div>
                    <div class="gauge-container" style="display: inline-block; position:relative; left: 10px;">
                        <div id="rgauge" class="gauge"></div>
                        <div id="rgaugeTitle" class="gaugeTitle">CPI</div>
                    </div>
                    <div class="data-border pull-right">
                        <ul class="list-group">
                            <li class="list-group-item">BAC: <span class="total-bac animated fadeIn"></span></li>
                            <li class="list-group-item">EAC:<span class="total-eacCum animated fadeIn"></span></li>
                            <li class="list-group-item">TCPIeac: <span class="total-tcpi animated fadeIn"></span></li>
                            <li class="list-group-item">User: <span class="user-name"></span></li>
                            <li class="list-group-item">Project: <span class="project"></span></li>
                            </ul>
                    </div>
                    <!--div style="display: inline-block">
                        <p>BAC = 123</p>
                        <p>EAC = 234</p>
                        <p>BAC = 123</p>
                        <p>EAC = 234</p>
                    </div-->
                </div>
            </div>
        </div>
        <div>
            <div class="chart-type-chooser">
                <div class="btn-group pull-left">
                    <button class="btn btn-primary btn-sm total-bcws"></button>
                    <button class="btn btn-info btn-sm total-bcwp"></button>
                    <button class="btn btn-success btn-sm total-eac"></button>
                    <button class="btn btn-warning btn-sm total-acwp"></button>
                </div>
                <strong class="radio-group-label">Chart type</strong>
                <ul class="radio-group">
                    <li><input type="radio" name="seriesType" value="area" id="seriesType-combo"><label for="seriesType-combo">Area</label></li>
                    <li><input type="radio" name="seriesType" value="column" id="seriesType-period"><label for="seriesType-period">Bar</label></li>
                    <li><input type="radio" name="seriesType" value="line" id="seriesType-s-curve"checked><label for="seriesType-s-curve">Bullseye</label></li>
                </ul>

                <!--div class="btn-group">
                    <button class="btn btn-primary btn-sm total-bcws"></button>
                    <button class="btn btn-info btn-sm total-bdwp"></button>
                    <button class="btn btn-success btn-sm total-eac"></button>
                    <button class="btn btn-warning btn-sm total-acwp"></button>
                </div-->
            </div>
            <div id="chart" ></div>
            <div class="chart-loading"></div>

        </div>
    </div>
</div>

<nav class="navbar navbar-default navbar-fixed-bottom" style="padding :15px;">
    <div class="col-xs-6 navbar-header">
        <div class="dropup">
            <a class=" dropdown-toggle" id="dropdownMenu2" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span class="k-icon k-i-custom"></span>
            </a>

            <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                <li><a href="#">Ones</a></li>
                <li><a href="#">Thousands</a></li>
                <li><a href="#">Millions</a></li>
                <li><a href="#">Billions</a></li>
            </ul>
        </div>
    </div>
    <div class="dropup" style="float:right;">
        <a class="dropdown-toggle" id="dropdownMenu3" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span class="navbar-link">Export to..</span></a>
        <ul class="dropdown-menu" aria-labelledby="dropdownMenu3" style="position: absolute; left: -130px">
            <li><span class="export-pdf k-icon k-i-pdf"></span></li>
            <!--li><span class="export-excel k-icon k-i-excel"></span></li-->
        </ul>
    </div>
</nav>


<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!-- Placed at the end of the document so the pages load faster -->
<script src="./assets/js/bootstrap.min.js"></script>
<script src="./assets/js/jszip.min.js"></script>
<script src="./assets/js/jquery.min.js"></script>
<script src="./assets/js/kendo.all.min.js"></script>
<script src="./assets/js/underscore.js"></script>
<script src="./assets/js/cultures/kendo.culture.en-GB.min.js"></script>
<script src="./assets/js/app.js"></script>
<script>
    var serviceRoot = "http://localhost";


    $(document).ready(function() {
        /** Added Body Selector - this is needed**/
        var body = $("body");
        kendo.culture('en-GB');
        /** console currency check**/
        console.log(kendo.toString(1234.567, "c0"));//$1,235

        showProgress(true);
        createSplitters();

        /** Begin Hierarchy Panel **/
        var hierData = hierListData();
        hierListInitialize(hierData);
        var chartData = ChartData();
        var chartDataSource = FilterChartData(chartData);
        var chartTotals = chartDataSource.totals;
        var chart = chartDataSource.graph;
        var gaugesData = chartDataSource.gauges;
        console.log(gaugesData);
        createGauge(gaugesData);

        var projectName = hierData[0].ExtID;
        displayTotals(chartTotals,projectName);
        console.log(JSON.stringify(chartTotals));
        // console.log(JSON.stringify(chart));

        var dataSourceMixed = new kendo.data.DataSource({
            data: _.flatten(chart),
            sort: {
                field: "Date",
                dir: "asc"
            },
            schema: {
                model: {
                    fields: {
                        Date: {type: "date"}
                    }
                }
            }
        });

        var series = [
            {
                name: "BCWS",
                type: "line",
                field: "BCWS",
                categoryField: "Date",
                //data:BCWSdata,
                color: "#428bca",
                markers: {type: "circle"}
            },
            {
                name: "BCWP",
                type: "line",
                field: "BCWP",
                categoryField: "Date",
                //data:BCWPdata,
                color: "#5bc0de",
                markers: {type: "circle"}
            },
            {
                name: "EAC",
                type: "line",
                field: "EAC",
                categoryField: "Date",
                //data:EACdata,
                color: "#5cb85c",
                markers: {type: "circle"}
            },
            {
                name: "ACWP",
                type: "line",
                field: "ACWP",
                categoryField: "Date",
                //data:ACWPdata,
                color: "#f0ad4e",
                markers: {type: "circle"}
            }
        ];

        createChart(dataSourceMixed, series);

        $(document).bind("kendo:skinChange", createChart);
        $(".chart-type-chooser").bind("change", refreshChart);/** Changed Refresh Chart Name for clarity**/
        var hierarchyList = $("div#treelist");
        _.debounce(expandTreeList(hierarchyList),500);

        /** setTimeout(function(){
            var $kGrid = hierarchyList.find('div.k-grid-content');
            var $treeTr =  $kGrid.find('tr');
          //  $treeTr.addClass('animated slideInRight');
           // $treeTr.attr('aria-expanded','true');
            $treeTr.eq(0).attr('aria-expanded','true').addClass('k-alt').removeAttr('style').find('td:first-child').find('span:nth-child(1)').toggleClass('k-i-expand k-i-collapse');
            $treeTr.eq(1).attr('aria-expanded','true').addClass('k-alt').removeAttr('style').find('td:first-child').find('span:nth-child(2)').toggleClass('k-i-expand k-i-collapse');
            $treeTr.eq(2).attr('aria-expanded','true').removeAttr('style');
                    //.find('td:first-child').find('span:nth-child(3)').toggleClass('k-i-expand k-i-collapse');
          //  $treeTr.eq(3).attr('aria-expanded','true');
        },200);**/

        var chartSelector = $("div#chart");

        /*********** New Hierarchy Button View Click Event ***************/
        hierarchyList.on('click','tr button.js-hier',function(e){
            e.preventDefault();
            var chartdata = '',
                    filteredSnapByParentId = '',
                    filteredSnapByIndex = [],
                    collectIndexes = [],
                    chartFiltered = '';
            console.log('hit selected row');
            var $target = $(e.currentTarget),
                    $treeList = hierarchyList.data("kendoTreeList"),
                    $chartGraph = chartSelector.data("kendoChart"),
                    $trParent = $target.parent().parent(),
                    $rowIndex = $trParent.index(),
                    $objectNumber = $target.data('objectNumber'),//data-objectNumber='#=data.ObjectNumber#'
                    $children = $target.data('children');
            console.log($rowIndex);
            chartdata = $chartGraph.dataSource.options.data;
            /**Change Title**/
            var extId = $treeList.dataSource.options.data[$rowIndex].ExtID;
            var description = $treeList.dataSource.options.data[$rowIndex].Description;
            $(document).find('.js-hier-title').text(extId+'  '+description);
            /** end title change **/
            switch($rowIndex){
                case 0:
                case 1:
                    chartFiltered =  FilterChartData(chartdata);
                    break;
                default:
                    if($children){
                        var allChildIndexes = allNodes($($trParent),collectIndexes);
                        console.log(JSON.stringify(allChildIndexes));
                        var Indexes = _.without(allChildIndexes,-1);
                        console.log(JSON.stringify(Indexes));
                        $.each(Indexes,function(key,value){//[data-children="false"]
                            filteredSnapByIndex.push({'ObjectNumber':$treeList.dataSource.options.data[value].ObjectNumber});
                        });
                        console.log('multiple '+JSON.stringify(filteredSnapByIndex));
                        filteredSnapByParentId = FilterByHierList(filteredSnapByIndex,chartdata);
                        chartFiltered =  FilterChartData(filteredSnapByParentId);
                    }else{
                        filteredSnapByIndex.push({'ObjectNumber':$treeList.dataSource.options.data[$rowIndex].ObjectNumber});
                        console.log('single '+JSON.stringify(filteredSnapByIndex));
                        filteredSnapByParentId = FilterByHierList(filteredSnapByIndex,chartdata);
                        chartFiltered =  FilterChartData(filteredSnapByParentId);
                    }
                    break;
            }
            if(chartFiltered != undefined){
                var chartTotalsFilteredBy =  _.flatten(chartFiltered.totals);
                console.log(chartTotalsFilteredBy);
                displayTotals(chartTotalsFilteredBy);

                var chartFilteredByParentId =  _.flatten(chartFiltered.graph);
                console.log(chartFilteredByParentId.length);
                $chartGraph.dataSource.data(chartFilteredByParentId);
                refreshChart();


                var gaugesData = _.flatten(chartFiltered.gauges);
                createGauge(gaugesData);
            }

        });

        $(".export-pdf").click(function () {
            $("#chart").getKendoChart().saveAsPDF();
        });

        function refreshChart() {
            var chart = $("#chart").data("kendoChart"),
                    type = $("input[name=seriesType]:checked").val();//,
            //stack = $("#stack").prop("checked");

            for (var i = 0, length = series.length; i < length; i++) {
                //series[i].stack = stack;
                series[i].type = type;
            }
            chart.setOptions({
                series: series
            });
        }

        /******** Added Show Progress Spinners Time Out **************/
        setTimeout(showProgress(false), 3500);

        function expandTreeList(selector){
            selector.data("kendoTreeList").expand(".k-treelist-group");
            selector.data("kendoTreeList").expand(".k-alt");
        }

    });//end of Doc Ready
</script>
</body>
</html>
