<!DOCTYPE html>
<html>
<head>
    <title>Dassian App</title>

    <!--link href="./assets/css/kendo.dataviz.default.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common-bootstrap.core.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common-bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.bootstrap.min.css" rel="stylesheet">-->
    <link href="./assets/css/kendo.dataviz.bootstrap.min.css" rel="stylesheet">
    <link href="./assets/css/kendo.common-fiori.core.min.css" rel="stylesheet">

    <script src="./assets/js/jszip.min.js"></script>

    <link href="./assets/css/default.css" rel="stylesheet">
    <link href="./assets/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/kendo.common-fiori.min.css"/>
    <link rel="stylesheet" href="./assets/css/kendo.fiori.min.css"/>
    <link rel="stylesheet" href="./assets/css/kendo.dataviz.min.css"/>
    <link rel="stylesheet" href="./assets/css/kendo.dataviz.fiori.min.css"/>

    <script src="./assets/js/jquery.min.js"></script>
    <script src="./assets/js/underscore.js"></script>
    <script src="./assets/js/kendo.culture.en-GB.min.js"></script>
    <script src="./assets/js/kendo.all.js"></script>
    <!-- <script src="./assets/js/moment.js"></script>-->
</head>

<body>
<!-- Fixed navbar -->
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="navbar-header">
        <a class="navbar-brand" target="_blank" href="http://www.dassian.com"><img alt="Dassian UK"
                                                                                   src="assets/img/dassian.png"
                                                                                   width="100px"></a>
    </div>
    <p style="margin-right: 5px" class="navbar-text navbar-right">Signed in as <a href="#" class="navbar-link">Tom
        Lau</a></p>
</nav>

<div class="container dashboard">
    <div class="panel panel-default ">
        <div class="panel-heading">
            <h3 class="panel-title">Project Analytics
                <span class="pull-right dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false"><span
                        class="k-icon k-i-hbars"></span></a>
                <ul class="dropdown-menu" role="menu">
                    <li><a href="#">Action</a></li>
                    <li><a href="#">Another action</a></li>
                    <li><a href="#">Something else here</a></li>
                    <li class="divider"></li>
                    <li><a href="#">Separated link</a></li>
                </ul>
                </span>
            </h3>
        </div>
        <div class="panel-body" style="padding: 0; margin: 0;">
            <!--   <div id="vertical" class="row" style="border: none">-->
            <div id="top-pane" class="row">
                <!--   <div id="horizontal" style="height: 100%; width: 100%;">-->
                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="well" style="margin-bottom: 0; min-height:510px">
                        <div id="treelist"></div>
                    </div>
                </div>

                <div class="col-lg-6 col-md-6 col-sm-6">
                    <div class="well">
                        <div id="gauge-container">
                            <div style="border: solid thin #3d3d3d;">
                                <div id="topgauge"></div>
                            </div>
                            <input id="gauge-value" class="form-control" value="1.5">

                            <div style="border: solid thin #3d3d3d;">
                                <div id="bottomgauge"></div>
                            </div>
                            <input id="gauge-value-bottom" class="form-control" value=".5">
                        </div>
                    </div>
                </div>
                <!-- </div>-->
            </div>
            <div>
                <div class="options">
                    <input id="typeArea" name="seriesType" type="radio" value="area" autocomplete="off"/>
                    <label for="typeArea">Area</label>

                    <input id="typeColumn" name="seriesType" type="radio" value="column" autocomplete="off"/>
                    <label for="typeColumn">Columns</label>

                    <input id="typeBar" name="seriesType" type="radio" value="bar" autocomplete="off"/>
                    <label for="typeBar">Bars</label>

                    <input id="typeLine" name="seriesType" type="radio" value="line" autocomplete="off"  checked="checked"/>
                    <label for="typeLine">Lines</label>

                    <input id="stack" type="checkbox" autocomplete="off"/>
                    <label for="stack">Stacked</label>
                </div>

                <div class="well bg-success" id="chart"></div>
                <div class="chart-loading"></div>
            </div>
            <!--  </div>-->
        </div>
    </div>
</div>
    <div class="navbar navbar-default navbar-fixed-bottom">
        <div class="navbar-header">
            <p class="navbar-text navbar-left"><span class="k-icon k-i-custom"></span></p>
        </div>
        <p style="margin-right: 10px" class="navbar-text navbar-right"><span class="export-pdf k-icon k-i-pdf"></span>
        </p>
    </div>

</body>
<!-- Placed at the end of the document so the pages load faster -->
<script src="./assets/js/bootstrap.min.js"></script>
<script>
    function createGauge() {
        $("#topgauge").kendoRadialGauge({
            pointer: {
                value: $("#gauge-value").val()
            },

            scale: {
                minorUnit: 5,
                startAngle: -30,
                endAngle: 210,
                max: 2
            }
        });
        $("#bottomgauge").kendoRadialGauge({
            pointer: {
                value: $("#gauge-value-bottom").val()
            },

            scale: {
                minorUnit: 5,
                startAngle: -30,
                endAngle: 210,
                max: 2
            }
        });
    }

    $(document).ready(function () {
       // var culture = kendo.culture();
      //  console.log(culture.name);
        kendo.culture('en-GB');
        console.log(kendo.toString(1234.567, "c0"));//$1,235

        createGauge();

        function updateValueTop() {
            $("#topgauge").data("kendoRadialGauge").value($("#gauge-value").val());
        }

        function updateValueBottom() {
            $("#bottomgauge").data("kendoRadialGauge").value($("#gauge-value-bottom").val());
        }

        if (kendo.ui.Slider) {
            $("#gauge-value").kendoSlider({
                min: 0,
                max: 2,
                showButtons: true,
                change: updateValueTop
            });
            $("#gauge-value-bottom").kendoSlider({
                min: 0,
                max: 2,
                showButtons: true,
                change: updateValueBottom
            });
        } else {
            $("#gauge-value").change(updateValueTop);
            $("#gauge-value-bottom").change(updateValueBottom);
        }

        /** $(document).bind("kendo:skinChange", function (e) {
            createGauge();
        });**/

        //  $("#treeview").kendoTreeView();
        var serviceUrl = "http://localhost";

        function hierData() {
            var hierSource = '';
            $.ajax({
                url: "http://localhost/HierarchySet?$format=json",
                method: "GET",
                dataType: 'json',
                async: false
            }).success(function (response) {
                //data = response.d.results;

            }).error(function (err) {
                alert('error ' + err);
            }).done(function (response) {
                console.log('HierarchySet complete ');
                $(document).find("#treelist").kendoTreeList({
                    dataSource: {
                        data: response.d.results,
                        schema: {
                            parse: function (response) {
                                //  console.log(response);
                                var items = [];
                                $.each(response, function (index, value) {
                                    var item = {
                                        "parentId": String(value.ParentObjNum).substr(2),
                                        "ParentObjNum": String(value.ParentObjNum).substr(2),
                                        "id": String(value.ObjectNumber).substr(2),
                                        "ObjectNumber": String(value.ObjectNumber).substr(2),
                                        "Type": value.Type,
                                        "ExtID": value.ExtID,
                                        "Description": value.Description,
                                        "Project": value.Project,
                                        "SortOrder": value.SortOrder
                                    };
                                    items.push(item);
                                });
                                // console.log(JSON.stringify(items));

                                return items;
                            },
                            schema: {
                                model: {
                                    id: "id",
                                    expanded: true
                                },
                                expanded: true
                            }
                        }
                    },
                    height: '450',
                    filterable: true,
                    sortable: true,
                    resizable: true,
                    columns: [
                        {field: "ExtID", title: "ID", width: 160},
                        //{ field: "ParentObjNum", title: "Parent", width: 120 },
                        //  { field: "ObjectNumber", title: "Child", width: 120 },
                        {field: "Project", width: 75, title: "Project"},
                        {field: "Description", width: 160, title: "Description"}
                        // { field: "ObjectNumber" }
                    ]
                });
            });
        }

        hierData();
       // $('#treelist').find('tr.k-treelist-group').attr("aria-expanded",'true');
        //  var data = hierData();
        //  console.log(data);


        /**  $("#vertical").kendoSplitter({
            orientation: "vertical",
            panes: [
                { collapsible: true },
                { collapsible: true, size: "1000px" }
            ]
        });

         $("#horizontal").kendoSplitter({
            panes: [
                { collapsible: true, size: "750px" },
                { collapsible: true }
            ]
        });**/


        $(".export-pdf").click(function () {
            $("#chart").getKendoChart().saveAsPDF();
        });




    /**dataSource.fetch(function() {
        var data = dataSource.data();
        $.each(data,function(key,value){
            console.log(value.Date);
        });
    }); **/

    var BCWS = '';
    var BDWP = '';
    var EAC = '';
    var ACWP = '';
    var dataChart = '';
        var rawData = '';
        var dataSource = '';
    $.ajax({
        url: "http://localhost/SnapshotSet?$format=json",
        method: "GET",
        dataType: 'json',
        async: false
    }).success(function (response) {
         //dataChart = response.d.results;
        rawData = response;

        BCWS = $.grep(response.d.results,function(item){
                if(item.Version === 'D02'){
                    return item.ValueType === '01';
                }
        });
        BDWP = $.grep(response.d.results,function(item){
            if(item.Version === 'D02'){
                return item.ValueType === 'P2';
            }
        });
        EAC = $.grep(response.d.results,function(item){
            if(item.Version === 'EA1'){
                return item;
            }
        });
        ACWP = $.grep(response.d.results,function(item){
            if(item.Version === '000'){
                return item;
            }
        });
    }).error(function (err) {
        alert('error ' + err);
    }).done(function (response) {

    });
        var pluckMany = function() {
            // get the property names to pluck
            var source = arguments[0];
            var propertiesToPluck = _.rest(arguments, 1);
            return _.map(source, function(item) {
                var obj = {};
                _.each(propertiesToPluck, function(property) {
                    obj[property] = item[property];
                });
                return obj;
            });
        };

        /**
      _.map(
         _.where(people, {city : "ny"}),
         function(person) {
        return { firstName: person.firstName, qty: person.qty };
    }
         );
         * **/
/**console.log(_.map(_.where(BDWP),function(value){
  return {"BDWP":Number(value.IntValProjCurr),"Date":value.Date}
})
);**/
//.pluck("IntValProjCurr", "Date")
     var master = [];
        var BCWSdata  = _.map(_.where(BCWS),function(value){
            return {"BCWS":Number(value.IntValProjCurr),"Date":value.Date}
        });
        master.push(BCWSdata);
        var BDWPdata  = _.map(_.where(BDWP),function(value){
            return {"BDWP":Number(value.IntValProjCurr),"Date":value.Date}
        });
        master.push(BDWPdata);
        var EACdata  =_.map(_.where(EAC),function(value){
            return {"EAC":Number(value.IntValProjCurr),"Date":value.Date}
        });
        master.push(EACdata);
        var ACWPdata  = _.map(_.where(ACWP),function(value){
            return {"ACWP":Number(value.IntValProjCurr),"Date":value.Date}
        });
        master.push(ACWPdata);
/**console.log(_.flatten(master));**/

        var dataSourceMixed = new kendo.data.DataSource({
            data:_.flatten(master),
            sort: {
                field: "Date",
                dir: "asc"
            },
            schema: {
                model: {
                    fields: {
                        // IntValProjCurr: {type: "number"},
                        Date: {type: "date"}
                    }
                }
            }

        });


    var series = [
        {
            name: "BCWS",
            type: "line",
            field: "BCWS",
            categoryField: "Date",
            //data:BCWSdata,//_.pluck(BCWS, 'IntValProjCurr')
            // Line chart marker type
            aggregate: "sum",
            color: "#3585ba",
            markers: {type: "square"}
        },
        {
            name: "BDWP",
            type: "line",
            field: "BDWP",
            categoryField: "Date",
            //data:BDWPdata,
            aggregate: "sum",
            color: "#5e449b",
            // Line chart marker type
            markers: {type: "square"}
        },
        {
            name: "EAC",
            type: "line",
            field: "EAC",
            categoryField: "Date",
            //data:EACdata,
             aggregate: "sum",
            color: "#1ba54a",
            // Line chart marker type
            markers: {type: "square"}
        },
        {
            name: "ACWP",
            type: "line",
            field: "ACWP",
            categoryField: "Date",
            //data:ACWPdata,
            aggregate: "sum",
            color: "#981b1e",
            // Line chart marker type
            markers: {type: "square"}
        }
    ];

    function createChart(dataSource,series) {
        $("#chart").kendoChart({
            pdf: {
                fileName: "Kendo UI Export.pdf",
                proxyURL: "http://localhost/kendo-ui/service/export"
            },
            dataSource: dataSourceMixed,
            height: 350,
            title: {
                text: "SnapshotSet"
            },
            legend: {
                position: "top"
            },
            seriesDefaults: {
                type: "line"
                /**markers: {
                    size: 10
                }**/
            },
            series: series,
            render: function(e) {
                // Clear up the loading indicator for this chart
                var loading = $(".chart-loading", e.sender.element.parent());
                kendo.ui.progress(loading, false);
            },
            categoryAxis: {
                baseUnit: "fit",
                title: {
                    text: "Date"
                },
                field: "Date",
                labels: {
                    rotation: -60,
                    dateFormats: {
                        days: "M/YYYY"
                    }
                },
                maxDateGroups: 65,
                crosshair: {
                    visible: false
                },
                line: {
                    visible: false
                },
                majorGridLines: {
                    visible: false
                }
            },
            valueAxis: {
               // name: "Currency",
                title: {text: String('&#163;') + ' Currency'},
                labels: { format: String('&#163;') + "{0}"},
                majorUnit:2000000,
                min:0,
                max:40000000
              /**, {
                name: "BDWP",
                title: { text: "BDWP" },
                min: 0,
                max: 161,
                majorUnit: 32
            }, {
                name: "EAC",
                title: { text: "EAC" },
                color: "#ec5e0a"
            }, {
                name: "ACWP",
                title: { text: "ACWP" },
                color: "#4e4141"
            }],**/
            },
            tooltip: {
                visible: true,
                shared: true,
               // format: "{0}",//&#163; {0}
                template: "#= kendo.format('{0:C}',value) #"
            }
        });
    }

        createChart(dataSource,series);
        $(document).bind("kendo:skinChange", createChart);
        kendo.ui.progress($(".chart-loading"), true);
        $(".options").bind("change", refresh);



    function refresh() {
        var chart = $("#chart").data("kendoChart"),
                type = $("input[name=seriesType]:checked").val(),
                stack = $("#stack").prop("checked");

        for (var i = 0, length = series.length; i < length; i++) {
            series[i].stack = stack;
            series[i].type = type;
        }

        chart.setOptions({
            series: series
        });
    }

});//end of Doc Ready

    /**dataSource = new kendo.data.DataSource({
           // type: "odata",
            data:rawData,
            sort: {
                field: "Date",
                dir: "asc"
            },
            schema: {
                parse: function (response) {
                    //console.log(response.d.results);
                    var items = {};
                    items.d = {};
                    items.d.results = [];
                    $.each(response.d.results, function (index, value) {
                        var item = {
                         "ObjectNumber": value.ObjectNumber,
                            "Version": value.Version,
                            "ValueType": value.ValueType,
                            "TransactionType": value.TransactionType,
                            "ObjCurr": value.ObjCurr,
                            "Date": value.Date,
                           // "IntValProjCurr": value.IntValProjCurr
                            "ExtValProjCurr": value.ExtValProjCurr,
                            "IntValCOArCurr": value.IntValCOArCurr,
                            "ExtValCoArCurr": value.ExtValCoArCurr,
                            "Quantity": value.Quantity,
                            "Project": value.Project
                        };

                        items.d.results.push(item);
                    });
                    // console.log(JSON.stringify(items));
                    return items.d.results;
                },
                model: {
                    fields: {
                       // IntValProjCurr: {type: "number"},
                        Date: {type: "date"}
                    }
                }
            }

        });**/
</script>

</html>